# 🚀 云服务器部署完整指南

本指南详细介绍如何在云服务器上部署在线影院直播系统。

## 📋 目录

1. [购买和配置云服务器](#1-购买和配置云服务器)
2. [连接服务器](#2-连接服务器)
3. [安装基础环境](#3-安装基础环境)
4. [部署 SRS 流媒体服务器](#4-部署-srs-流媒体服务器)
5. [部署 Node.js 聊天服务器](#5-部署-nodejs-聊天服务器)
6. [配置防火墙](#6-配置防火墙)
7. [域名配置（可选）](#7-域名配置可选)
8. [HTTPS 配置（可选）](#8-https-配置可选)
9. [性能优化](#9-性能优化)

---

## 1. 购买和配置云服务器

### 推荐服务商

- **阿里云**：https://www.aliyun.com/
- **腾讯云**：https://cloud.tencent.com/
- **华为云**：https://www.huaweicloud.com/

### 服务器配置建议

#### 基础配置（2-5 人观看）
```
CPU：     2核
内存：    4GB
带宽：    5Mbps
系统盘：  40GB
操作系统：CentOS 7.x / Ubuntu 20.04
```

#### 标准配置（5-10 人观看）
```
CPU：     4核
内存：    8GB
带宽：    10Mbps
系统盘：  40GB
操作系统：CentOS 7.x / Ubuntu 20.04
```

#### 高级配置（10-30 人观看）
```
CPU：     8核
内存：    16GB
带宽：    20Mbps
系统盘：  40GB
操作系统：CentOS 7.x / Ubuntu 20.04
```

### 购买要点

1. **地域选择**：选择离用户最近的地域（降低延迟）
2. **计费方式**：
   - 按量付费：短期使用、测试
   - 包年包月：长期使用，更便宜
3. **公网 IP**：必须勾选，用于外网访问
4. **安全组**：选择默认安全组，后续手动配置

---

## 2. 连接服务器

### Windows 用户

#### 使用 PuTTY
1. 下载 PuTTY：https://www.putty.org/
2. 打开 PuTTY，输入服务器 IP
3. 端口：22，连接类型：SSH
4. 点击 Open，输入用户名（root）和密码

#### 使用 Windows Terminal（推荐）
```powershell
ssh root@你的服务器IP
# 输入密码
```

### Mac / Linux 用户

打开终端：
```bash
ssh root@你的服务器IP
# 输入密码
```

---

## 3. 安装基础环境

### 更新系统

#### CentOS
```bash
yum update -y
```

#### Ubuntu
```bash
apt update && apt upgrade -y
```

### 安装常用工具

#### CentOS
```bash
yum install -y wget curl vim git unzip
```

#### Ubuntu
```bash
apt install -y wget curl vim git unzip
```

### 安装 Node.js

使用 NodeSource 仓库安装 Node.js 18.x：

#### CentOS
```bash
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs
```

#### Ubuntu
```bash
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs
```

验证安装：
```bash
node --version  # 应显示 v18.x.x
npm --version   # 应显示 9.x.x 或更高
```

### 安装 Docker（推荐）

#### CentOS
```bash
# 安装 Docker
yum install -y yum-utils
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install -y docker-ce docker-ce-cli containerd.io

# 启动 Docker
systemctl start docker
systemctl enable docker

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

#### Ubuntu
```bash
# 安装 Docker
curl -fsSL https://get.docker.com | sh

# 启动 Docker
systemctl start docker
systemctl enable docker

# 安装 Docker Compose
curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

验证安装：
```bash
docker --version
docker-compose --version
```

---

## 4. 部署 SRS 流媒体服务器

### 方式一：使用 Docker（推荐）

#### 1. 创建工作目录
```bash
mkdir -p /opt/cinema
cd /opt/cinema
```

#### 2. 创建 SRS 配置文件
```bash
cat > srs.conf << 'EOF'
listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}

vhost __defaultVhost__ {
    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
    }
    
    hls {
        enabled         on;
        hls_path        ./objs/nginx/html;
        hls_fragment    3;
        hls_window      20;
        hls_cleanup     on;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
    
    gop_cache       on;
    queue_length    10;
    min_latency     on;
    tcp_nodelay     on;
}
EOF
```

#### 3. 启动 SRS
```bash
docker run -d \
  --name srs \
  --restart unless-stopped \
  -p 1935:1935 \
  -p 1985:1985 \
  -p 8080:8080 \
  -v $(pwd)/srs.conf:/usr/local/srs/conf/srs.conf \
  -v $(pwd)/srs-data:/usr/local/srs/objs/nginx/html \
  ossrs/srs:5
```

#### 4. 检查运行状态
```bash
docker ps | grep srs
docker logs srs
```

### 方式二：源码编译安装

#### 1. 下载 SRS
```bash
cd /opt
wget https://github.com/ossrs/srs/releases/download/v5.0-r0/SRS-CentOS7-x86_64-5.0.187.tar.gz
tar -xzf SRS-CentOS7-x86_64-5.0.187.tar.gz
cd SRS-CentOS7-x86_64-5.0.187
```

#### 2. 使用配置文件（同上）

#### 3. 启动 SRS
```bash
./objs/srs -c conf/srs.conf
```

#### 4. 后台运行（使用 screen）
```bash
yum install -y screen  # 或 apt install screen
screen -S srs
./objs/srs -c conf/srs.conf
# 按 Ctrl+A+D 退出 screen
# screen -r srs  # 重新连接
```

---

## 5. 部署 Node.js 聊天服务器

### 1. 上传项目文件

#### 方式一：使用 Git（推荐）
```bash
cd /opt
git clone https://github.com/你的用户名/cinema.git
cd cinema
```

#### 方式二：使用 FTP/SFTP 上传
- 使用 FileZilla 或 WinSCP 上传项目文件到 `/opt/cinema`

#### 方式三：手动创建
```bash
mkdir -p /opt/cinema
cd /opt/cinema

# 下载或复制所有项目文件
# package.json, server.js, public/* 等
```

### 2. 安装依赖
```bash
cd /opt/cinema
npm install --production
```

### 3. 测试运行
```bash
node server.js
```

访问 `http://服务器IP:3000` 测试是否正常

### 4. 使用 PM2 守护进程（推荐）

#### 安装 PM2
```bash
npm install -g pm2
```

#### 启动应用
```bash
cd /opt/cinema
pm2 start server.js --name cinema-chat
```

#### PM2 常用命令
```bash
pm2 list              # 查看进程列表
pm2 logs cinema-chat  # 查看日志
pm2 restart cinema-chat  # 重启
pm2 stop cinema-chat  # 停止
pm2 delete cinema-chat  # 删除

# 开机自启
pm2 startup
pm2 save
```

---

## 6. 配置防火墙

### CentOS 7 (firewalld)

```bash
# 开放端口
firewall-cmd --permanent --add-port=1935/tcp  # RTMP
firewall-cmd --permanent --add-port=8080/tcp  # HTTP-FLV/HLS
firewall-cmd --permanent --add-port=1985/tcp  # SRS API
firewall-cmd --permanent --add-port=3000/tcp  # Web 服务
firewall-cmd --reload

# 查看已开放端口
firewall-cmd --list-ports
```

### Ubuntu (ufw)

```bash
# 开放端口
ufw allow 1935/tcp
ufw allow 8080/tcp
ufw allow 1985/tcp
ufw allow 3000/tcp

# 启用防火墙
ufw enable

# 查看状态
ufw status
```

### 云服务商安全组

**重要！** 还需要在云服务商控制台配置安全组：

1. 登录云服务商控制台
2. 找到你的服务器 → 安全组
3. 添加入方向规则：
   - 端口 1935，协议 TCP，源地址 0.0.0.0/0
   - 端口 8080，协议 TCP，源地址 0.0.0.0/0
   - 端口 1985，协议 TCP，源地址 0.0.0.0/0
   - 端口 3000，协议 TCP，源地址 0.0.0.0/0

---

## 7. 域名配置（可选）

### 1. 购买域名
- 阿里云：https://wanwang.aliyun.com/
- 腾讯云：https://dnspod.cloud.tencent.com/

### 2. 域名解析
在域名管理后台添加 A 记录：
```
类型：A
主机记录：cinema（或 @）
记录值：你的服务器公网 IP
TTL：10 分钟
```

### 3. 安装 Nginx

#### CentOS
```bash
yum install -y nginx
systemctl start nginx
systemctl enable nginx
```

#### Ubuntu
```bash
apt install -y nginx
systemctl start nginx
systemctl enable nginx
```

### 4. 配置 Nginx 反向代理

```bash
cat > /etc/nginx/conf.d/cinema.conf << 'EOF'
server {
    listen 80;
    server_name cinema.yourdomain.com;  # 改成你的域名

    # Web 界面和 WebSocket
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 直播流
    location /live/ {
        proxy_pass http://localhost:8080/live/;
        proxy_set_header Host $host;
        
        # 添加 CORS 头
        add_header Access-Control-Allow-Origin *;
    }

    # SRS API
    location /api/ {
        proxy_pass http://localhost:1985/api/;
        proxy_set_header Host $host;
    }
}
EOF
```

重载 Nginx：
```bash
nginx -t  # 测试配置
nginx -s reload  # 重载配置
```

---

## 8. HTTPS 配置（可选）

### 使用 Let's Encrypt 免费 SSL 证书

#### 1. 安装 Certbot

##### CentOS
```bash
yum install -y epel-release
yum install -y certbot python3-certbot-nginx
```

##### Ubuntu
```bash
apt install -y certbot python3-certbot-nginx
```

#### 2. 获取证书
```bash
certbot --nginx -d cinema.yourdomain.com
```

按提示操作：
- 输入邮箱
- 同意服务条款
- 选择是否重定向 HTTP 到 HTTPS（推荐选择 2）

#### 3. 自动续期
```bash
# 测试续期
certbot renew --dry-run

# Certbot 会自动添加定时任务
```

#### 4. 更新 Nginx 配置

Certbot 会自动修改配置，最终配置类似：
```nginx
server {
    listen 443 ssl;
    server_name cinema.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/cinema.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cinema.yourdomain.com/privkey.pem;

    # ... 其他配置同上
}

server {
    listen 80;
    server_name cinema.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 9. 性能优化

### 系统优化

#### 提高文件描述符限制
```bash
# 临时设置
ulimit -n 65535

# 永久设置
cat >> /etc/security/limits.conf << EOF
* soft nofile 65535
* hard nofile 65535
EOF
```

#### 网络参数优化
```bash
cat >> /etc/sysctl.conf << EOF
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.tcp_congestion_control = bbr
EOF

sysctl -p
```

### SRS 优化

在 `srs.conf` 中添加：
```conf
vhost __defaultVhost__ {
    # 减少延迟
    min_latency     on;
    
    # GOP 缓存
    gop_cache       on;
    gop_cache_max_frames 2500;
    
    # 队列长度
    queue_length    10;
    
    # TCP 无延迟
    tcp_nodelay     on;
    
    # 性能调优
    in_ack_size     2500;
    out_ack_size    2500;
}
```

### Node.js 优化

#### 使用集群模式
修改 `server.js`：
```javascript
const cluster = require('cluster');
const os = require('os');

if (cluster.isMaster) {
    const numCPUs = os.cpus().length;
    for (let i = 0; i < numCPUs; i++) {
        cluster.fork();
    }
    cluster.on('exit', (worker) => {
        console.log(`Worker ${worker.process.pid} died`);
        cluster.fork();
    });
} else {
    // 原有代码
}
```

---

## 🧪 部署验证

### 1. 检查服务状态

```bash
# 检查 SRS
docker ps | grep srs
# 或
ps aux | grep srs

# 检查 Node.js
pm2 list

# 检查端口监听
netstat -tlnp | grep -E "1935|8080|3000"
```

### 2. 测试推流

使用 FFmpeg 推测试流：
```bash
ffmpeg -re -i test.mp4 -c copy -f flv rtmp://服务器IP:1935/live/test
```

### 3. 测试播放

浏览器访问：
```
http://服务器IP:3000
```

输入流地址：
```
http://服务器IP:8080/live/test.flv
```

### 4. 检查日志

```bash
# SRS 日志
docker logs -f srs
# 或
tail -f /opt/SRS-CentOS7-x86_64-5.0.187/objs/srs.log

# Node.js 日志
pm2 logs cinema-chat
```

---

## 📊 监控和维护

### 系统监控

```bash
# 安装 htop
yum install -y htop  # 或 apt install htop
htop

# 查看磁盘使用
df -h

# 查看网络流量
yum install -y iftop  # 或 apt install iftop
iftop
```

### SRS 监控

访问 SRS API：
```bash
curl http://localhost:1985/api/v1/summaries
```

### 日志管理

```bash
# 定期清理日志
cat > /etc/cron.daily/clean-logs << 'EOF'
#!/bin/bash
find /opt/cinema/logs -name "*.log" -mtime +7 -delete
find /var/log/nginx -name "*.log" -mtime +30 -delete
EOF

chmod +x /etc/cron.daily/clean-logs
```

---

## 🔒 安全加固

### 1. 修改 SSH 端口
```bash
vim /etc/ssh/sshd_config
# 修改 Port 22 为其他端口（如 2222）
systemctl restart sshd
```

### 2. 禁用 root 登录
```bash
# 先创建普通用户
useradd -m -s /bin/bash cinema
passwd cinema
usermod -aG sudo cinema  # Ubuntu
usermod -aG wheel cinema  # CentOS

# 禁用 root 登录
vim /etc/ssh/sshd_config
# PermitRootLogin no
systemctl restart sshd
```

### 3. 安装 Fail2Ban
```bash
yum install -y fail2ban  # 或 apt install fail2ban
systemctl start fail2ban
systemctl enable fail2ban
```

---

## ❓ 常见问题

### 无法推流

1. 检查防火墙是否开放 1935 端口
2. 检查 SRS 是否正常运行
3. 检查云服务商安全组配置

### 网页无法访问

1. 检查 3000 端口是否开放
2. 检查 Node.js 服务是否运行
3. 查看服务器日志

### 直播流无法播放

1. 检查 8080 端口是否开放
2. 确认推流地址和播放地址一致
3. 检查浏览器控制台错误信息

---

**部署完成！祝你使用愉快！🎉**

